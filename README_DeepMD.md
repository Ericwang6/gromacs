# GROMACS + DeepMD NNP/MM Simulations
This README is drafted by Yingze Wang from CCME, Peking University.

## Installation
1. Download code from https://github.com/Ericwang6/gromacs/tree/deepmd-v3
2. Install C++ api of both `tensorflow 2.x` and `deepmd-kit 2.x`.
3. Specify the installation path of tensorflow and deepmd using cmake options: `-DTENSORFLOW_ROOT` and `-DDEEPMD_ROOT`. Here is a sample compile scipt:
```bash
#!/bin/bash
export CC=/usr/bin/gcc
export CXX=/usr/bin/g++
export CMAKE_PREFIX_PATH="/path/to/fftw-3.3.9" # fftw libraries
mkdir build
cd build
TENSORFLOW_ROOT="/path/to/tensorflow"
DEEPMD_ROOT="/path/to/tensorflow"

cmake3 .. -DCMAKE_CXX_STANDARD=14 \ # not required, but c++14 seems to be more compatible with higher version of tensorflow
          -DGMX_TENSORFLOW_ROOT=${TENSORFLOW_ROOT} \
          -DGMX_DEEPMD_ROOT=${DEEPMD_ROOT} \
          -DGMX_MPI=ON -DGMX_GPU=CUDA \
          -DCUDA_TOOLKIT_ROOT_DIR=/path/to/cuda \
          -DCMAKE_INSTALL_PREFIX=/path/to/gromacs-2020.2-deepmd-v3
make -j
make install
```
+ Tips: C++ api of deepmd and tensorflow could be easily installed from the deepmd-kit offline packages, but before using tensorflow, one need to manually change the `protobuf` package to version 3.9.2 (the offline package will install a version of 3.14, which will cause incompability).

## Usage
### 1. Topology Preparation
Similar to QM/MM simulation, the internal interactions (including bond, angle, dihedrals, LJ, Columb) of the region descibed by a neural network potential (NNP) have to be turned off. In GROMACS, bonded interactions can be turned off by modifying `[ bonds ]`, `[ angles ]`, `[ dihedrals ]` and `[ pairs ]` sections. And LJ and Columb interactions must be turned off by `[ exclusions ]` section.

For example, if one wants to simulate ethane in water, using DeepPotential for ethane and TIP3P for water, the topology of ethane should be like the following:
```
[ atomtypes ]
;name   bond_type     mass     charge   ptype   sigma         epsilon       Amb
 c3       c3          0.00000  0.00000   A     3.39967e-01   4.57730e-01 ; 1.91  0.1094
 hc       hc          0.00000  0.00000   A     2.64953e-01   6.56888e-02 ; 1.49  0.0157

[ moleculetype ]
;name            nrexcl
 ethane           3

[ atoms ]
;   nr  type  resi  res  atom  cgnr     charge      mass       ; qtot   bond_type
     1   c3     1   MOL    C1    1    -0.095100     12.01000 ; qtot -0.095
     2   c3     1   MOL    C2    2    -0.095100     12.01000 ; qtot -0.190
     3   hc     1   MOL    H1    3     0.031700      1.00800 ; qtot -0.158
     4   hc     1   MOL    H2    4     0.031700      1.00800 ; qtot -0.127
     5   hc     1   MOL    H3    5     0.031700      1.00800 ; qtot -0.095
     6   hc     1   MOL    H4    6     0.031700      1.00800 ; qtot -0.063
     7   hc     1   MOL    H5    7     0.031700      1.00800 ; qtot -0.032
     8   hc     1   MOL    H6    8     0.031700      1.00800 ; qtot 0.000

[ bonds ]
; func = 5 means no interactions between atom i and atom j, but they are also connected by a 'bond'.
; this is useful when using constraints in mdp.
; i  j  func  b0  kb
 1  2     5        
 1  3     5        
 1  4     5        
 1  5     5        
 2  6     5        
 2  7     5        
 2  8     5        

[ exclusions ]
; ai  aj1  aj2  aj3  aj4  aj5  aj6  aj7
  1    2    3    4    5    6    7    8
  2    1    3    4    5    6    7    8
  3    1    2    4    5    6    7    8
  4    1    2    3    5    6    7    8
  5    1    2    3    4    6    7    8
  6    1    2    3    4    5    7    8
  7    1    2    3    4    5    6    8
  8    1    2    3    4    5    6    7

```
For comparsion, the original topology of ethane looks like (generated by `acpype`)
```
; ethane_GMX.itp created by acpype (v: 2021-02-05T22:15:50CET) on Sat Sep  4 15:48:39 2021

[ atomtypes ]
;name   bond_type     mass     charge   ptype   sigma         epsilon       Amb
 c3       c3          0.00000  0.00000   A     3.39967e-01   4.57730e-01 ; 1.91  0.1094
 hc       hc          0.00000  0.00000   A     2.64953e-01   6.56888e-02 ; 1.49  0.0157

[ moleculetype ]
;name            nrexcl
 ethane           3

[ atoms ]
;   nr  type  resi  res  atom  cgnr     charge      mass       ; qtot   bond_type
     1   c3     1   MOL    C1    1    -0.095100     12.01000 ; qtot -0.095
     2   c3     1   MOL    C2    2    -0.095100     12.01000 ; qtot -0.190
     3   hc     1   MOL    H1    3     0.031700      1.00800 ; qtot -0.158
     4   hc     1   MOL    H2    4     0.031700      1.00800 ; qtot -0.127
     5   hc     1   MOL    H3    5     0.031700      1.00800 ; qtot -0.095
     6   hc     1   MOL    H4    6     0.031700      1.00800 ; qtot -0.063
     7   hc     1   MOL    H5    7     0.031700      1.00800 ; qtot -0.032
     8   hc     1   MOL    H6    8     0.031700      1.00800 ; qtot 0.000

[ bonds ]
;   ai     aj funct   r             k
     1      2   1    1.5375e-01    2.5179e+05 ;     C1 - C2    
     1      3   1    1.0969e-01    2.7665e+05 ;     C1 - H1    
     1      4   1    1.0969e-01    2.7665e+05 ;     C1 - H2    
     1      5   1    1.0969e-01    2.7665e+05 ;     C1 - H3    
     2      6   1    1.0969e-01    2.7665e+05 ;     C2 - H4    
     2      7   1    1.0969e-01    2.7665e+05 ;     C2 - H5    
     2      8   1    1.0969e-01    2.7665e+05 ;     C2 - H6    

[ pairs ]
;   ai     aj    funct
     3      6      1 ;     H1 - H4    
     3      7      1 ;     H1 - H5    
     3      8      1 ;     H1 - H6    
     4      6      1 ;     H2 - H4    
     4      7      1 ;     H2 - H5    
     4      8      1 ;     H2 - H6    
     5      6      1 ;     H3 - H4    
     5      7      1 ;     H3 - H5    
     5      8      1 ;     H3 - H6    

[ angles ]
;   ai     aj     ak    funct   theta         cth
     1      2      6      1    1.0980e+02    3.8744e+02 ;     C1 - C2     - H4    
     1      2      7      1    1.0980e+02    3.8744e+02 ;     C1 - C2     - H5    
     1      2      8      1    1.0980e+02    3.8744e+02 ;     C1 - C2     - H6    
     2      1      3      1    1.0980e+02    3.8744e+02 ;     C2 - C1     - H1    
     2      1      4      1    1.0980e+02    3.8744e+02 ;     C2 - C1     - H2    
     2      1      5      1    1.0980e+02    3.8744e+02 ;     C2 - C1     - H3    
     3      1      4      1    1.0758e+02    3.2970e+02 ;     H1 - C1     - H2    
     3      1      5      1    1.0758e+02    3.2970e+02 ;     H1 - C1     - H3    
     4      1      5      1    1.0758e+02    3.2970e+02 ;     H2 - C1     - H3    
     6      2      7      1    1.0758e+02    3.2970e+02 ;     H4 - C2     - H5    
     6      2      8      1    1.0758e+02    3.2970e+02 ;     H4 - C2     - H6    
     7      2      8      1    1.0758e+02    3.2970e+02 ;     H5 - C2     - H6    

[ dihedrals ] ; propers
; for gromacs 4.5 or higher, using funct 9
;    i      j      k      l   func   phase     kd      pn
     3      1      2      6      9     0.00   0.62760   3 ;     H1-    C1-    C2-    H4
     3      1      2      7      9     0.00   0.62760   3 ;     H1-    C1-    C2-    H5
     3      1      2      8      9     0.00   0.62760   3 ;     H1-    C1-    C2-    H6
     4      1      2      6      9     0.00   0.62760   3 ;     H2-    C1-    C2-    H4
     4      1      2      7      9     0.00   0.62760   3 ;     H2-    C1-    C2-    H5
     4      1      2      8      9     0.00   0.62760   3 ;     H2-    C1-    C2-    H6
     5      1      2      6      9     0.00   0.62760   3 ;     H3-    C1-    C2-    H4
     5      1      2      7      9     0.00   0.62760   3 ;     H3-    C1-    C2-    H5
     5      1      2      8      9     0.00   0.62760   3 ;     H3-    C1-    C2-    H6
```
### 2. DeepMD Settings
Before running simulation, we need to tell GROMACS to use DeepPotential by setting environment variable `GMX_DEEPMD_INPUT_JSON`:
```bash
export GMX_DEEPMD_INPUT_JSON=input.json
```
Then, in your working directories, we have to write `input.json` file:
```json
{
    "graph_file": "/path/to/graph.pb",
    "type_file": "type.raw",
    "index_file": "index.raw",
    "lambda": 1.0,
    "pbc": false
}
```
Here is an explanation for these settings:
+ `graph_file` : The graph file (with suffix .pb) generated by `dp freeze` command
+ `type_file` : File to specify DP atom types (in space-sepreated format). Here, `type.raw` looks like
```
1 1 0 0 0 0 0 0
```
+ `index_file` : File containing indices of DP atoms (in space-seperated format), which should be in consistent with indices' order in .gro file but **starting from zero**. Here, `index.raw` looks like
```
0 1 2 3 4 5 6 7
```
+ `lambda`: Optional, default 1.0. Used in alchemical calculations.
+ `pbc`: Optional, default true. If true, the GROMACS peroidic condition is passed to DeepMD.

### 3. Run Simulation
Finally, you can run GROMACS using `gmx mdrun` as usual.

## For Developers
+ `src/gromacs/mdlib/deepmd_plugin.cpp` : deepmd-plugin definitions
+ `src/gromacs/mdlib/sim_utils.cpp` : force and energy calculations of DeepMD in `do_force` function (https://github.com/Ericwang6/gromacs/blob/4d695074a04cf12f6aee50b8e465696c067957ba/src/gromacs/mdlib/sim_util.cpp#L1845-L1929)
+ `src/gromacs/mdlib/forcerec.cpp` : deepmd-plugin init



